# Lefthook configuration for git hooks
# See: https://github.com/evilmartians/lefthook
#
# Strategy:
#   pre-commit  = progress-friendly (auto-fix, parallel, fast)
#   pre-push    = strict gate (all checks must pass before push)
#
# Branch awareness:
#   Markdownlint messaging adapts to the current branch.
#   On main: strongly recommends resolving issues before pushing.
#   On feature branches: advisory tone, non-blocking.

pre-commit:
  parallel: true
  commands:
    lint:
      glob: "*.{js,ts}"
      run: bun run lint:fix
      stage_fixed: true

    format:
      glob: "*.{js,ts,json}"
      run: bun run format
      stage_fixed: true

    type-check:
      glob: "*.ts"
      run: bun run typecheck

    ls-lint:
      run: bun run ls-lint

    markdownlint:
      glob: "*.md"
      run: |
        if bun run markdownlint 2>&1; then
          exit 0
        fi
        branch=$(git branch --show-current 2>/dev/null || echo "unknown")
        if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
          printf '\n\e[33m  WARNING: Markdown issues found on %s.\e[0m\n' "$branch"
          printf '  Strongly recommend fixing before push (push WILL be blocked).\n'
          printf '  Run: bun run markdownlint:fix\n\n'
        else
          printf '\n\e[36m  Info: Markdown issues found (non-blocking on commit).\e[0m\n'
          printf '  These will need fixing before merging to main.\n'
          printf '  Run: bun run markdownlint:fix\n\n'
        fi
        exit 0

pre-push:
  parallel: false
  commands:
    test:
      run: bun run test

    build:
      run: bun run build

    ls-lint:
      run: bun run ls-lint

    markdownlint:
      run: bun run markdownlint
